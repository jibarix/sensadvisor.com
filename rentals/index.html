<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Puerto Rico Rent Analytics | SENS ADVISOR</title>

  <!-- Chart.js (UMD) + Box/Violin Plot (UMD) to ensure boxplot controller is registered -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-chart-box-and-violin-plot/4.0.0/Chart.BoxPlot.min.js"></script>

  <!-- Google Fonts - Source Code Pro -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* Design System Variables */
    :root {
      --primary-bg: #ffffff;
      --primary-text: #000000;
      --secondary-text: #333333;
      --border-primary: #000000;
      --accent-light: #f0f0f0;
      --accent-lighter: #f9f9f9;
      --success-bg: #e6ffe6;
      --success-border: #00cc00;
      --info-bg: #e6f3ff;
      --info-border: #0066cc;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Source Code Pro', monospace;
      background: var(--primary-bg);
      color: var(--primary-text);
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header */
    .header {
      position: sticky;
      top: 0;
      background: var(--primary-bg);
      border-bottom: 2px solid var(--border-primary);
      margin-bottom: 40px;
      padding-bottom: 20px;
      z-index: 100;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .logo {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-text);
      text-decoration: none;
    }

    /* Header links */
    .header-links {
      display: flex;
      gap: 14px;
      align-items: center;
      font-size: 0.85rem;
      color: var(--secondary-text);
    }

    .header-links a {
      font-weight: 600;
      text-decoration: underline;
    }

    .header h1 {
      font-size: 1.8rem;
      font-weight: 600;
      margin-top: 15px;
    }

    .header .subtitle {
      font-size: 0.9rem;
      color: var(--secondary-text);
      margin-top: 5px;
      font-weight: 400;
    }

    /* Overview Section */
    .overview {
      background: var(--primary-bg);              /* white */
      border: 2px solid var(--border-primary);    /* black border */
      border-radius: 8px;
      padding: 25px;
      margin-bottom: 40px;
    }

    .overview h2 {
      font-size: 1.3rem;
      font-weight: 600;
      margin-bottom: 15px;
      color: var(--primary-text);
    }

    .overview h3 {
      font-size: 1rem;
      font-weight: 600;
      margin-top: 20px;
      margin-bottom: 10px;
      color: var(--primary-text);
    }

    .overview p {
      font-size: 0.9rem;
      color: var(--primary-text);
      margin-bottom: 12px;
      line-height: 1.7;
    }

    .overview ul {
      margin-left: 20px;
      margin-bottom: 12px;
    }

    .overview li {
      font-size: 0.9rem;
      color: var(--primary-text);
      margin-bottom: 8px;
      line-height: 1.6;
    }

    .overview code {
      background: var(--accent-light);
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: var(--accent-lighter);
      border: 2px solid var(--border-primary);
      border-radius: 8px;
      padding: 20px;
      transition: all 0.2s ease;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
    }

    .stat-card .label {
      font-size: 0.75rem;
      color: var(--secondary-text);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .stat-card .value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary-text);
      margin-bottom: 5px;
    }

    .stat-card .change {
      font-size: 0.8rem;
      margin-top: 8px;
      font-weight: 500;
    }

    .change.positive { color: #00aa00; }
    .change.negative { color: #cc0000; }

    /* Panel System */
    .panel {
      background: var(--primary-bg);
      border: 2px solid var(--border-primary);
      border-radius: 8px;
      padding: 30px;
      margin-bottom: 40px;
      transition: all 0.2s ease;
    }

    .panel:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
    }

    .panel h2 {
      font-size: 1.3rem;
      font-weight: 600;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .panel-note {
      font-size: 0.75rem;
      font-weight: 400;
      color: var(--secondary-text);
    }

    .panel-description {
      font-size: 0.85rem;
      color: var(--secondary-text);
      margin-bottom: 15px;
    }

    /* Grid Layout */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 30px;
      margin-bottom: 40px;
    }

    .grid-full {
      grid-column: 1 / -1;
    }

    /* Tables */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    th, td {
      padding: 12px 10px;
      text-align: left;
      border-bottom: 1px solid #ddd;
      font-size: 0.85rem;
    }

    th {
      background: var(--accent-lighter);
      font-weight: 600;
      color: var(--primary-text);
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.5px;
    }

    tbody tr {
      transition: background 0.15s ease;
    }

    tbody tr:hover {
      background: var(--accent-light);
    }

    /* Badges */
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border: 1px solid;
    }

    .badge.deal {
      background: var(--success-bg);
      color: #006600;
      border-color: var(--success-border);
    }

    .badge.overpriced {
      background: #ffe6e6;
      color: #990000;
      border-color: #cc0000;
    }

    .badge.high {
      background: #fff9e6;
      color: #996600;
      border-color: #cc9900;
    }

    /* States */
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--secondary-text);
      font-weight: 500;
    }

    .error {
      background: #ffe6e6;
      color: #990000;
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
      border: 2px solid #cc0000;
      font-weight: 500;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--secondary-text);
      font-weight: 400;
    }

    /* Charts */
    canvas {
      max-height: 350px;
      margin-top: 15px;
    }

    /* Links */
    a {
      color: var(--primary-text);
      text-decoration: underline;
      font-weight: 500;
      transition: color 0.2s ease;
    }

    a:hover {
      color: var(--secondary-text);
    }

    /* Disclaimer section */
    .disclaimer {
      margin-top: 40px;
      padding-top: 30px;
      border-top: 2px solid var(--border-primary);
    }

    .disclaimer h2 {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 12px;
    }

    .disclaimer h3 {
      font-size: 0.95rem;
      font-weight: 700;
      margin-top: 16px;
      margin-bottom: 6px;
    }

    .disclaimer p {
      font-size: 0.85rem;
      color: var(--secondary-text);
      margin-bottom: 10px;
    }

    /* Footer */
    .footer {
      border-top: 2px solid var(--border-primary);
      margin-top: 60px;
      padding-top: 20px;
      text-align: center;
      color: var(--secondary-text);
      font-size: 0.85rem;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
      }

      .grid {
        grid-template-columns: 1fr;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      table {
        font-size: 0.75rem;
      }

      th, td {
        padding: 8px 6px;
      }
    }

    /* Chart.js Custom Styling */
    .chartjs-render-monitor {
      border: 1px solid #ddd;
      border-radius: 4px;
      background: var(--accent-lighter);
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <a href="/" class="logo">SENS ADVISOR</a>

        <div class="header-links">
          <a href="#overview">Overview</a>
          <a href="#disclaimer">Disclaimer</a>
        </div>
      </div>

    <h1>San Juan Rental Market Dashboard | ML Pricing Signals</h1>
    <div class="subtitle">
      Condado/Miramar, Hato Rey, Santurce, Viejo San Juan • Tracked beyond original ask range ($399–$1,800)
    </div>

    </header>

    <!-- Overview Section -->
    <section id="overview" class="overview">
      <h2>Dashboard Overview</h2>

      <p>
        This dashboard provides data-driven insights into the San Juan rental market using machine learning
        to identify pricing patterns and potential opportunities. Data is collected twice daily from public
        listings and analyzed using an ensemble of regression models.
      </p>

      <h3>Understanding the Metrics</h3>

      <p><strong>Great Deals vs. Top Underpriced Opportunities</strong></p>
      <p>
        These two metrics use different thresholds to serve different purposes:
      </p>
      <ul>
        <li><strong>"Great Deals" (Stats Card):</strong> High-confidence opportunities with <code>residual &lt; -$200</code> AND <code>anomaly_score &gt; 2.0</code>. These represent listings significantly below predicted market value with strong statistical confidence.</li>
        <li><strong>"Top Underpriced Opportunities" (Table):</strong> Broader set with <code>residual &lt; -$150</code> AND <code>anomaly_score &gt; 2.0</code>. This lower threshold captures more potential deals for further investigation.</li>
      </ul>

      <h3>Key Terminology</h3>
      <ul>
        <li><strong>Neighborhood:</strong> Geographic area within San Juan (e.g., Condado, Santurce)</li>
        <li><strong>Residual:</strong> Difference between actual price and predicted price (negative = underpriced)</li>
        <li><strong>Anomaly Score:</strong> Statistical measure of how unusual a listing is (higher = more unusual)</li>
        <li><strong>Median Absolute Error (MAE):</strong> Model accuracy metric - average prediction error in dollars</li>
        <li><strong>Days on Market:</strong> Time since listing first appeared (active listings only)</li>
      </ul>

      <h3>How to Use This Dashboard</h3>
      <ul>
        <li><strong>Identify Value:</strong> Check "Top Underpriced Opportunities" for potential deals</li>
        <li><strong>Track Trends:</strong> Monitor median price changes over time by neighborhood</li>
        <li><strong>Assess Market:</strong> Review price distribution and inventory levels</li>
        <li><strong>Validate Listings:</strong> Cross-reference model predictions with actual listings before making decisions</li>
      </ul>

      <p style="margin-top: 15px;">
        <strong>Important:</strong> This tool is for analysis and exploration only. Always verify listings
        independently and consult professionals before making rental decisions.
      </p>
    </section>

    <!-- Stats Overview -->
    <div class="stats-grid" id="statsGrid">
      <div class="loading">Initializing analytics...</div>
    </div>

    <!-- Charts Grid -->
    <div class="grid">
      <div class="panel">
        <h2>Median Price Trends <span class="panel-note">30-day rolling</span></h2>
        <canvas id="medianChart"></canvas>
      </div>

      <div class="panel">
        <h2>Price Distribution <span class="panel-note">Current inventory</span></h2>
        <canvas id="distChart"></canvas>
      </div>

      <div class="panel">
        <h2>Inventory by Neighborhood <span class="panel-note">Active listings</span></h2>
        <canvas id="invChart"></canvas>
      </div>

      <div class="panel">
        <h2>Days on Market <span class="panel-note">Active listings</span></h2>
        <div id="daysError"></div>
        <canvas id="daysChart"></canvas>
      </div>

      <div class="panel">
        <h2>Model Feature Importance <span class="panel-note">Ensemble weights</span></h2>
        <div id="featureError"></div>
        <canvas id="featureChart"></canvas>
      </div>
    </div>

    <!-- NEW: Price Distribution by Neighborhood (Boxplot) -->
    <div class="panel grid-full">
      <h2>Price Distribution by Neighborhood <span class="panel-note">Quartile analysis</span></h2>
      <div id="boxplotError"></div>
      <canvas id="boxplotChart"></canvas>
    </div>

    <!-- Scatter Plot -->
    <div class="panel grid-full">
      <h2>Price vs Prediction Scatter <span class="panel-note">Green = underpriced | Red = overpriced</span></h2>
      <div id="scatterError"></div>
      <canvas id="scatterChart"></canvas>
    </div>

    <!-- Deals Table -->
    <div class="panel">
      <h2>Top Underpriced Opportunities <span class="panel-note">Potential market inefficiencies</span></h2>
      <p class="panel-description">
        Listings with <code>residual &lt; -$150</code> AND <code>anomaly_score &gt; 2.0</code>. Lower threshold than "Great Deals" to capture more opportunities for investigation.
      </p>
      <div id="dealsError"></div>
      <table id="dealsTable">
        <thead>
          <tr>
            <th>Status</th>
            <th>Location</th>
            <th>Beds/Baths</th>
            <th>Actual</th>
            <th>Predicted</th>
            <th>Discount</th>
            <th>Score</th>
            <th>Features</th>
            <th>Link</th>
          </tr>
        </thead>
        <tbody><tr><td colspan="9" class="loading">Loading...</td></tr></tbody>
      </table>
    </div>

    <!-- Anomalies Table -->
    <div class="panel">
      <h2>Price Anomalies <span class="panel-note">Statistical outliers</span></h2>
      <div id="anomError"></div>
      <table id="anomTable">
        <thead>
          <tr>
            <th>Type</th>
            <th>Location</th>
            <th>Beds/Baths</th>
            <th>Actual</th>
            <th>Predicted</th>
            <th>Difference</th>
            <th>Score</th>
            <th>Link</th>
          </tr>
        </thead>
        <tbody><tr><td colspan="8" class="loading">Loading...</td></tr></tbody>
      </table>
    </div>

    <!-- Disclaimer Section -->
    <section id="disclaimer" class="disclaimer">
      <h2>Disclaimer</h2>

      <h3>Data Sources</h3>
      <p>
        Data is collected from publicly available sources and structured inputs using automated extraction and ingestion processes.
        The dataset represents snapshots captured at specific points in time and may not reflect the most current state of listings or prices.
      </p>

      <h3>Data Limitations</h3>
      <p>
        The data may contain inaccuracies, missing fields, duplicates, or outdated information originating from source material or automated parsing.
        Coverage may be uneven across regions, time periods, or listing types. The system does not guarantee correctness, completeness, or timeliness.
      </p>

      <h3>Data Processing</h3>
      <p>
        Raw data is cleaned, normalized, and transformed prior to modeling. This includes deduplication, handling missing or inconsistent values,
        and deriving structured features used for analysis. Some information may be simplified or discarded during processing.
      </p>

      <h3>Machine Learning Models (ensemble_v2)</h3>
      <p>
        Predictions are generated using a weighted ensemble of supervised regression models: <strong>Ridge Regression</strong>,
        <strong>Random Forest Regression</strong>, and <strong>Gradient Boosting Regression</strong>.
      </p>

      <h3>Interpretation and Use of Predictions</h3>
      <p>
        Predictions are intended to support analysis and exploration, not to replace human judgment. Outputs represent probabilistic estimates
        based on historical patterns and should be interpreted as indicative rather than guaranteed. Do not rely on predictions as the sole basis
        for high-risk decisions.
      </p>
    </section>

    <!-- Footer -->
    <footer class="footer">
      <p>&copy; 2025 Sens ABI LLC. All rights reserved. | Rental Market Analytics Platform</p>
    </footer>
  </div>

  <script>
    let charts = {};

    // Chart.js default config for consistent styling
    Chart.defaults.font.family = "'Source Code Pro', monospace";
    Chart.defaults.font.size = 11;
    Chart.defaults.color = '#000000';
    Chart.defaults.borderColor = '#dddddd';

    // Optional safety: some builds expose registerables via ChartBoxPlot
    if (window.ChartBoxPlot && ChartBoxPlot.registerables) {
      Chart.register(...ChartBoxPlot.registerables);
    }

    // Monochrome color palette
    const colors = [
      'rgba(0, 0, 0, 0.9)',
      'rgba(51, 51, 51, 0.8)',
      'rgba(102, 102, 102, 0.7)',
      'rgba(153, 153, 153, 0.6)',
      'rgba(204, 204, 204, 0.5)',
    ];

    const greenColor = 'rgba(0, 170, 0, 0.7)';
    const redColor = 'rgba(204, 0, 0, 0.7)';
    const grayColor = 'rgba(149, 149, 149, 0.4)';

    // Utility functions
    function fmt(n) { return n != null ? n.toLocaleString() : '—'; }
    function fmtUSD(n) { return n != null ? '$' + n.toLocaleString() : '—'; }
    function fmtPct(n) { return n != null ? (n * 100).toFixed(1) + '%' : '—'; }

    async function loadStats() {
      try {
        const res = await fetch('./data/stats.json');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        const grid = document.getElementById('statsGrid');
        grid.innerHTML = `
          <div class="stat-card">
            <div class="label">Active Listings</div>
            <div class="value">${fmt(data.total_listings)}</div>
            <div class="change positive">+${fmt(data.new_this_week)} this week</div>
          </div>
          <div class="stat-card">
            <div class="label">Median Price</div>
            <div class="value">${fmtUSD(data.median_price)}</div>
            <div class="change ${data.price_change_pct >= 0 ? 'positive' : 'negative'}">
              ${data.price_change_pct >= 0 ? '+' : ''}${fmtPct(data.price_change_pct)} vs last month
            </div>
          </div>
          <div class="stat-card">
            <div class="label">Median Days on Market</div>
            <div class="value">${data.median_days_on_market != null ? data.median_days_on_market.toFixed(1) : '—'}</div>
            <div class="change">Active listings only</div>
          </div>
          <div class="stat-card">
            <div class="label">Model Accuracy</div>
            <div class="value">${fmtUSD(data.model_mdae)}</div>
            <div class="change">Median absolute error</div>
          </div>
          <div class="stat-card">
            <div class="label">Great Deals</div>
            <div class="value">${fmt(data.underpriced_count)}</div>
            <div class="change">Residual < -$200 & score > 2.0</div>
          </div>
        `;
      } catch (e) {
        console.error('loadStats error:', e);
        document.getElementById('statsGrid').innerHTML = `<div class="error">Error loading stats: ${e.message}</div>`;
      }
    }

    async function loadMedianPrices() {
      try {
        const res = await fetch('./data/median_price.json');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const rows = await res.json();

        if (!rows || rows.length === 0) {
          console.warn('No median price data');
          return;
        }

        const grouped = {};
        rows.forEach(r => {
          if (!grouped[r.municipio]) grouped[r.municipio] = [];
          grouped[r.municipio].push(r);
        });

        const volumes = Object.entries(grouped).map(([m, data]) => ({
          municipio: m,
          total: data.reduce((sum, d) => sum + d.n, 0)
        })).sort((a, b) => b.total - a.total);

        const top = volumes.slice(0, 5).map(v => v.municipio);

        const datasets = top.map((m, i) => ({
          label: m,
          data: grouped[m].map(d => ({ x: d.day, y: d.median_price })),
          borderColor: colors[i],
          backgroundColor: colors[i].replace('0.9', '0.1'),
          borderWidth: 2,
          tension: 0.3,
          fill: false,
          pointRadius: 3,
          pointHoverRadius: 5,
        }));

        const days = [...new Set(rows.map(r => r.day))].sort();

        destroyChart('medianChart');
        const ctx = document.getElementById('medianChart').getContext('2d');
        charts.medianChart = new Chart(ctx, {
          type: 'line',
          data: { labels: days, datasets },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  boxWidth: 12,
                  padding: 10,
                  font: { size: 10 }
                }
              },
              tooltip: {
                callbacks: {
                  label: ctx => `${ctx.dataset.label}: ${fmtUSD(ctx.parsed.y)}`
                }
              }
            },
            scales: {
              y: {
                ticks: { callback: v => fmtUSD(v) },
                grid: { color: '#f0f0f0' }
              },
              x: {
                grid: { color: '#f0f0f0' }
              }
            }
          }
        });
      } catch (e) {
        console.error('loadMedianPrices error:', e);
      }
    }

    async function loadDistribution() {
      try {
        const res = await fetch('./data/distribution.json');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        if (!data || !data.bins || data.bins.length === 0) {
          console.warn('No distribution data');
          return;
        }

        destroyChart('distChart');
        const ctx = document.getElementById('distChart').getContext('2d');
        charts.distChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: data.bins,
            datasets: [{
              label: 'Listings',
              data: data.counts,
              backgroundColor: colors[0],
              borderColor: '#000000',
              borderWidth: 1,
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: '#f0f0f0' }
              },
              x: {
                grid: { display: false }
              }
            }
          }
        });
      } catch (e) {
        console.error('loadDistribution error:', e);
      }
    }

    async function loadInventory() {
      try {
        const res = await fetch('./data/inventory.json');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        if (!data || data.length === 0) {
          console.warn('No inventory data');
          return;
        }

        destroyChart('invChart');
        const ctx = document.getElementById('invChart').getContext('2d');
        charts.invChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: data.map(d => d.municipio),
            datasets: [{
              label: 'Active Listings',
              data: data.map(d => d.count),
              backgroundColor: colors[1],
              borderColor: '#000000',
              borderWidth: 1,
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            plugins: {
              legend: { display: false }
            },
            scales: {
              x: {
                grid: { color: '#f0f0f0' }
              },
              y: {
                grid: { display: false }
              }
            }
          }
        });
      } catch (e) {
        console.error('loadInventory error:', e);
      }
    }

    async function loadDaysOnMarket() {
      try {
        const res = await fetch('./data/days_on_market.json');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        if (!data || data.length === 0) {
          document.getElementById('daysError').innerHTML = '<div class="empty-state">No days-on-market data yet.</div>';
          return;
        }

        document.getElementById('daysError').innerHTML = '';
        destroyChart('daysChart');
        const ctx = document.getElementById('daysChart').getContext('2d');
        charts.daysChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: data.map(d => d.bucket),
            datasets: [{
              label: 'Listings',
              data: data.map(d => d.count),
              backgroundColor: colors[3],
              borderColor: '#000000',
              borderWidth: 1,
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: ctx => `${ctx.parsed.y} listings`
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: '#f0f0f0' },
                title: { display: true, text: 'Number of Listings' }
              },
              x: {
                grid: { display: false },
                title: { display: true, text: 'Time on Market' }
              }
            }
          }
        });
      } catch (e) {
        console.error('loadDaysOnMarket error:', e);
        document.getElementById('daysError').innerHTML = `<div class="error">Error: ${e.message}</div>`;
      }
    }

    async function loadPriceBoxplot() {
      try {
        const res = await fetch('./data/price_by_neighborhood.json');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        if (!data || data.length === 0) {
          document.getElementById('boxplotError').innerHTML = '<div class="empty-state">No neighborhood price data yet.</div>';
          return;
        }

        // Sort by median price descending
        data.sort((a, b) => b.median - a.median);

        document.getElementById('boxplotError').innerHTML = '';
        destroyChart('boxplotChart');
        const ctx = document.getElementById('boxplotChart').getContext('2d');

        charts.boxplotChart = new Chart(ctx, {
          type: 'boxplot',
          data: {
            labels: data.map(d => d.municipio),
            datasets: [{
              label: 'Price Distribution',
              backgroundColor: 'rgba(0, 0, 0, 0.2)',
              borderColor: 'rgba(0, 0, 0, 0.9)',
              borderWidth: 2,
              outlierColor: 'rgba(204, 0, 0, 0.7)',
              padding: 10,
              itemRadius: 3,
              data: data.map(d => ({
                min: d.min_price,
                q1: d.q1,
                median: d.median,
                q3: d.q3,
                max: d.max_price,
                mean: d.mean_price,
                items: []
              }))
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (ctx) => {
                    const d = data[ctx.dataIndex];
                    return [
                      `Median: ${fmtUSD(d.median)}`,
                      `Q1-Q3: ${fmtUSD(d.q1)} - ${fmtUSD(d.q3)}`,
                      `Range: ${fmtUSD(d.min_price)} - ${fmtUSD(d.max_price)}`,
                      `Mean: ${fmtUSD(Math.round(d.mean_price))}`,
                      `Count: ${d.count} listings`
                    ];
                  }
                }
              }
            },
            scales: {
              y: {
                title: { display: true, text: 'Monthly Rent (USD)' },
                ticks: { callback: v => fmtUSD(v) },
                grid: { color: '#f0f0f0' }
              },
              x: {
                title: { display: true, text: 'Neighborhood' },
                grid: { display: false }
              }
            }
          }
        });
      } catch (e) {
        console.error('loadPriceBoxplot error:', e);
        document.getElementById('boxplotError').innerHTML = `<div class="error">Error: ${e.message}</div>`;
      }
    }

    async function loadFeatureImportance() {
      try {
        const res = await fetch('./data/feature_importance.json');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        if (!data || data.length === 0) {
          document.getElementById('featureError').innerHTML = '<div class="empty-state">No feature importance data yet. Run ml_v2.py first.</div>';
          return;
        }

        document.getElementById('featureError').innerHTML = '';
        destroyChart('featureChart');
        const ctx = document.getElementById('featureChart').getContext('2d');
        charts.featureChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: data.map(d => d.feature),
            datasets: [{
              label: 'Importance',
              data: data.map(d => d.importance),
              backgroundColor: colors[2],
              borderColor: '#000000',
              borderWidth: 1,
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            plugins: {
              legend: { display: false }
            },
            scales: {
              x: {
                beginAtZero: true,
                grid: { color: '#f0f0f0' }
              },
              y: {
                grid: { display: false }
              }
            }
          }
        });
      } catch (e) {
        console.error('loadFeatureImportance error:', e);
        document.getElementById('featureError').innerHTML = `<div class="error">Error: ${e.message}</div>`;
      }
    }

    async function loadScatter() {
      try {
        const res = await fetch('./data/scatter.json');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const rows = await res.json();

        if (!rows || rows.length === 0) {
          document.getElementById('scatterError').innerHTML = '<div class="empty-state">No prediction data yet. Run ml_v2.py first.</div>';
          return;
        }

        document.getElementById('scatterError').innerHTML = '';
        destroyChart('scatterChart');
        const ctx = document.getElementById('scatterChart').getContext('2d');

        charts.scatterChart = new Chart(ctx, {
          type: 'scatter',
          data: {
            datasets: [
              {
                label: 'Underpriced',
                data: rows.filter(r => r.residual < -200).map(r => ({
                  x: r.price,
                  y: r.predicted_price,
                  ad_id: r.ad_id,
                  municipio: r.municipio
                })),
                backgroundColor: greenColor,
                borderColor: '#00aa00',
                borderWidth: 1,
                pointRadius: 5,
                pointHoverRadius: 7,
              },
              {
                label: 'Fair Price',
                data: rows.filter(r => Math.abs(r.residual) <= 200).map(r => ({
                  x: r.price,
                  y: r.predicted_price,
                  ad_id: r.ad_id,
                  municipio: r.municipio
                })),
                backgroundColor: grayColor,
                borderColor: '#999999',
                borderWidth: 1,
                pointRadius: 3,
                pointHoverRadius: 5,
              },
              {
                label: 'Overpriced',
                data: rows.filter(r => r.residual > 200).map(r => ({
                  x: r.price,
                  y: r.predicted_price,
                  ad_id: r.ad_id,
                  municipio: r.municipio
                })),
                backgroundColor: redColor,
                borderColor: '#cc0000',
                borderWidth: 1,
                pointRadius: 5,
                pointHoverRadius: 7,
              }
            ]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  boxWidth: 12,
                  padding: 10,
                  font: { size: 10 }
                }
              },
              tooltip: {
                callbacks: {
                  label: ctx => {
                    const d = ctx.raw;
                    return [
                      `Actual: ${fmtUSD(d.x)}`,
                      `Predicted: ${fmtUSD(d.y)}`,
                      `Neighborhood: ${d.municipio}`,
                      `Ad ID: ${d.ad_id}`
                    ];
                  }
                }
              }
            },
            scales: {
              x: {
                title: { display: true, text: 'Actual Price' },
                ticks: { callback: v => fmtUSD(v) },
                grid: { color: '#f0f0f0' }
              },
              y: {
                title: { display: true, text: 'Predicted Price' },
                ticks: { callback: v => fmtUSD(v) },
                grid: { color: '#f0f0f0' }
              }
            }
          }
        });
      } catch (e) {
        console.error('loadScatter error:', e);
        document.getElementById('scatterError').innerHTML = `<div class="error">Error: ${e.message}</div>`;
      }
    }

    async function loadDeals() {
      try {
        const res = await fetch('./data/deals.json');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const rows = await res.json();

        const tbody = document.querySelector('#dealsTable tbody');

        if (!rows || rows.length === 0) {
          tbody.innerHTML = '<tr><td colspan="9" class="empty-state">No deals found yet. More data needed.</td></tr>';
          return;
        }

        document.getElementById('dealsError').innerHTML = '';
        tbody.innerHTML = '';

        rows.forEach(r => {
          const discount = ((r.price - r.predicted_price) / r.predicted_price * 100).toFixed(1);
          const features = [];
          if (r.furnished) features.push('Furnished');
          if (r.internet) features.push('Internet');
          if (r.parking) features.push('Parking');
          if (r.plan8_accepted) features.push('Plan 8');

          tbody.innerHTML += `
            <tr>
              <td><span class="badge deal">DEAL</span></td>
              <td>${r.municipio || '—'}</td>
              <td>${r.bedrooms || '—'} / ${r.bathrooms || '—'}</td>
              <td>${fmtUSD(r.price)}</td>
              <td>${fmtUSD(Math.round(r.predicted_price))}</td>
              <td style="color: #00aa00; font-weight: 700;">${discount}%</td>
              <td>${r.anomaly_score.toFixed(2)}</td>
              <td style="font-size: 0.75rem;">${features.join(', ') || '—'}</td>
              <td><a href="${r.url}" target="_blank">View</a></td>
            </tr>
          `;
        });
      } catch (e) {
        console.error('loadDeals error:', e);
        document.getElementById('dealsError').innerHTML = `<div class="error">Error: ${e.message}</div>`;
      }
    }

    async function loadAnomalies() {
      try {
        const res = await fetch('./data/anomalies.json');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const rows = await res.json();

        const tbody = document.querySelector('#anomTable tbody');

        if (!rows || rows.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No anomalies detected yet.</td></tr>';
          return;
        }

        document.getElementById('anomError').innerHTML = '';
        tbody.innerHTML = '';

        rows.forEach(r => {
          const type = r.residual < 0 ? 'Underpriced' : 'Overpriced';
          const badgeClass = r.residual < 0 ? 'deal' : 'overpriced';
          const diff = Math.abs(r.residual);

          tbody.innerHTML += `
            <tr>
              <td><span class="badge ${badgeClass}">${type}</span></td>
              <td>${r.municipio || '—'}</td>
              <td>${r.bedrooms || '—'} / ${r.bathrooms || '—'}</td>
              <td>${fmtUSD(r.price)}</td>
              <td>${fmtUSD(Math.round(r.predicted_price))}</td>
              <td style="font-weight: 700;">${fmtUSD(Math.round(diff))}</td>
              <td>${r.anomaly_score.toFixed(2)}</td>
              <td><a href="${r.url}" target="_blank">View</a></td>
            </tr>
          `;
        });
      } catch (e) {
        console.error('loadAnomalies error:', e);
        document.getElementById('anomError').innerHTML = `<div class="error">Error: ${e.message}</div>`;
      }
    }

    function destroyChart(id) {
      if (charts[id]) {
        charts[id].destroy();
        delete charts[id];
      }
    }

    async function refreshAll() {
      try {
        console.log('Loading dashboard...');
        await Promise.all([
          loadStats(),
          loadMedianPrices(),
          loadDistribution(),
          loadInventory(),
          loadDaysOnMarket(),
          loadPriceBoxplot(),
          loadFeatureImportance(),
          loadScatter(),
          loadDeals(),
          loadAnomalies()
        ]);
        console.log('Dashboard loaded successfully');
      } catch (e) {
        console.error('Error loading dashboard:', e);
      }
    }

    // Initialize on page load
    console.log('Initializing dashboard...');
    refreshAll();
  </script>
</body>
</html>
